generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Unit {
  id        String   @id @default(uuid())
  name      String
  address   String
  latitude  Float
  longitude Float
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users        User[]
  services     Service[]
  appointments Appointment[]

  @@map("units")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String
  passwordHash String   @map("password_hash")
  role         Role
  phone        String?
  specialties  String[] @default([])
  photoUrl     String?  @map("photo_url")
  isActive     Boolean  @default(true) @map("is_active")
  unitId       String   @map("unit_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  unit                Unit          @relation(fields: [unitId], references: [id])
  barberAppointments  Appointment[] @relation("BarberAppointments")
  createdAppointments Appointment[] @relation("CreatedBy")
  sessions            Session[]
  auditLogs           AuditLog[]
  notifications       Notification[]

  @@index([email])
  @@index([unitId])
  @@index([role])
  @@map("users")
}

model Client {
  id        String    @id @default(uuid())
  name      String
  email     String?
  phone     String    @unique
  cpf       String?   @unique
  birthDate DateTime? @map("birth_date")
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  appointments Appointment[]

  @@index([phone])
  @@index([cpf])
  @@map("clients")
}

model Service {
  id              String   @id @default(uuid())
  name            String
  description     String?
  durationMinutes Int      @map("duration_minutes")
  price           Decimal  @db.Decimal(10, 2)
  isActive        Boolean  @default(true) @map("is_active")
  unitId          String   @map("unit_id")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  unit         Unit          @relation(fields: [unitId], references: [id])
  appointments Appointment[]
  appointmentServices AppointmentService[]

  @@index([unitId])
  @@index([isActive])
  @@map("services")
}

model Appointment {
  id            String            @id @default(uuid())
  clientId      String            @map("client_id")
  barberId      String            @map("barber_id")
  serviceId     String            @map("service_id")
  unitId        String            @map("unit_id")
  scheduledDate DateTime          @map("scheduled_date")
  status        AppointmentStatus
  observations  String?           @db.Text
  createdAt     DateTime          @default(now()) @map("created_at")
  createdBy     String            @map("created_by")
  cancelledAt   DateTime?         @map("cancelled_at")
  cancelledBy   String?           @map("cancelled_by")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  client  Client  @relation(fields: [clientId], references: [id])
  barber  User    @relation("BarberAppointments", fields: [barberId], references: [id])
  service Service @relation(fields: [serviceId], references: [id])
  unit    Unit    @relation(fields: [unitId], references: [id])
  creator User    @relation("CreatedBy", fields: [createdBy], references: [id])
  services AppointmentService[]

  @@index([barberId, scheduledDate])
  @@index([clientId])
  @@index([scheduledDate])
  @@index([status])
  @@map("appointments")
}

model AppointmentService {
  id              String      @id @default(uuid())
  appointmentId   String      @map("appointment_id")
  serviceId       String      @map("service_id")
  price           Decimal?    @db.Decimal(10, 2)
  durationMinutes Int?        @map("duration_minutes")
  createdAt       DateTime    @default(now()) @map("created_at")

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  service     Service     @relation(fields: [serviceId], references: [id])

  @@unique([appointmentId, serviceId])
  @@map("appointment_services")
}
model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  token        String   @unique
  refreshToken String   @unique @map("refresh_token")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  deviceInfo   Json?    @map("device_info")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  entityType String?  @map("entity_type")
  entityId   String?  @map("entity_id")
  details    Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  message   String           @db.Text
  data      Json?
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")
  readAt    DateTime?        @map("read_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum Role {
  ADMINISTRATOR
  BARBER
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  PRESENT
  ABSENT
  CANCELLED
  COMPLETED
}

enum NotificationType {
  APPOINTMENT_REMINDER
  CLIENT_ARRIVED
  APPOINTMENT_CANCELLED
  RESCHEDULE_REQUEST
  SYSTEM_ALERT
}